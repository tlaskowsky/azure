# APIマネジメント：リクエストとレスポンスのポリシー

ポリシーは、APIマネジメントでAPI操作の動作を変更できるプラグイン機能です。入力ポリシーはバックエンドが呼び出される前に発動し、リクエストを変更したり、バックエンドをまったく呼び出さないようにすることができます。出力ポリシーはバックエンドが呼び出された後に発動し、クライアントに送信される前にレスポンスを変更することができます。

すでにいくつかのポリシーを使用しました - キャッシングやモックレスポンスの送信などですが、APIのセキュリティを強化するために常に追加すべき他のポリシーがいくつかあります。

このラボでは、APIMを介して公開APIを提示し、セキュリティを強化するためにポリシーを使用します。

## 参照

- [APIの保護](https://learn.microsoft.com/en-us/azure/api-management/transform-api)

## バックエンドAPIの探索

開発者に人気のある公開APIであるSWAPI - スターウォーズAPIがあります。https://swapi.dev でそのAPIについて読むことができます。これは、スターウォーズ映画のキャラクターや場所、その他のデータタイプに関する情報を返すREST APIです。

この公開APIをAPIMインスタンスを介して公開することができます。

> はい、その使用ポリシーが許可していれば、サードパーティのAPIをフロントエンドとして設定できます

[Postman](https://www.postman.com/downloads/) を開き、SWAPIリソースの1つに対してGETリクエストを行います：



```
https://swapi.dev/api/people/3
```

レスポンスを調べると、2つの潜在的なセキュリティ問題があります：

- `Server` ヘッダーには `nginx` という値があり、これを公開したくありません
- レスポンスボディには元のAPIへの多くのリンクが含まれていますが、これを人々に見せたくありません

これらは攻撃者がレスポンスを送ったサーバーソフトウェアを知りたがるため、問題です。そのソフトウェアのバージョンに既知の脆弱性がないか確認するためです。

また、ポリシーが適用されていることを知るために、トラフィックをAPIM内に保ちたいと思います。レスポンスに元のサーバーへのリンクが含まれている場合、攻撃者はAPIMをバイパスし、直接ソースにアクセスすることができます。

これらはいずれもレスポンスポリシーで修正できます。

SWAPIも公共サービスであり、その帯域幅を尊重するべきです。APIには独自のレート制限があり、IPアドレスごとに呼び出しを制限しています。通常、1人のエンドユーザーが制限を超えることはありませんが、すべての呼び出しが1つのAPIM IPアドレスから行われるため、レスポンスをキャッシュし、負荷をすべてSWAPIに渡さないようにしたいと思います。

## APIマネジメントでAPIを作成

APIMで新しい_手動定義された_ HTTP APIを追加し、WebサービスURLとして `https://swapi.dev/api` を設定します。

次の操作を追加します：

- GET `/people/{personId}`
	- `200 OK` レスポンスを返す
	- `application/json` レスポンス
	- レスポンスエンティティはこのサンプルのようになります：



```
{
	"name": "R2-D2",
	"height": "96",
	"mass": "32",
	"hair_color": "n/a",
	"skin_color": "white, blue",
	"eye_color": "red",
	"birth_year": "33BBY",
	"gender": "n/a",
	"homeworld": "https://swapi.dev/api/planets/8/",
	"films": [
		"https://swapi.dev/api/films/1/",
		"https://swapi.dev/api/films/2/",
		"https://swapi.dev/api/films/3/",
		"https://swapi.dev/api/films/4/",
		"https://swapi.dev/api/films/5/",
		"https://swapi.dev/api/films/6/"
	],
	"species": [
		"https://swapi.dev/api/species/2/"
	],
	"vehicles": [],
	"starships": [],
	"created": "2014-12-10T15:11:50.376000Z",
	"edited": "2014-12-20T21:17:50.311000Z",
	"url": "https://swapi.dev/api/people/3/"
}
```

SWAPIには他のリソースタイプもありますが、私たちはAPIMを通して _people（人々）_ のみを公開する予定です。

## ヘッダー＆キャッシュポリシーの設定

APIを保護するために、次の3つのポリシーを操作に追加します：

- 応答キャッシュを使用するためのインバウンドポリシー - キャッシュ期間を `86400` 秒（1日間）に設定
- `Server` レスポンスヘッダーを削除するためのアウトバウンドポリシー
- カスタムの `x-server` レスポンスヘッダーを書き込むためのアウトバウンドポリシー、値は `swapi-apim`
- レスポンスボディ内のすべてのSWAPI URLを自分のAPIM URLに置き換えるためのアウトバウンドポリシー、リンクは機能するが元のURLは表示されない

📋 デザイナーを通じて操作をテストし、ポリシーが期待通りに機能しているかを確認します。

<details>
  <summary>ヘルプが必要ですか？</summary>

応答キャッシュとヘッダー操作は操作UIで見つけられる標準ポリシーです。

レスポンス内のすべてのURLを置き換えるには、_その他のポリシー_ にエントリが必要です。これはXMLビューで、必要なスニペットがあります。スニペットをXMLの正しい位置に追加してください。

</details><br/>

## APIを公開＆テスト

SWAPI APIをAPIMの製品の1つに追加し、Postman（または `curl -v`）を使用して `/people` 操作をテストします：

- ヘッダーにサブスクリプションキーを提示しない場合、401エラーが発生するはずです
- 認証されたリクエストは有効なレスポンスを取得する必要があります
- レスポンス内のURLは `swapi.dev` ではなく、あなたのAPIMドメインを使用するべきです
- レスポンスヘッダーには元の `Server` ヘッダーではなく、あなたの `x-server` 値が含まれるべきです



```

## ラボ

SWAPIからのレスポンスはかなり良いRESTです。たとえば、`people/3`には _species（種）_ フィールドがあり、`species/2`へのリンクがあります。これらのリンクを自分のAPIMラッパーからSWAPIにたどることができますか？それは良いことですか、悪いことですか？

> 詰まったら、[提案](suggestions_jp.md) を試してみてください
___

## クリーンアップ

**まだクリーンアップしないでください！**

1つのAPIMインスタンスは複数のAPIをホストでき、次のラボでは同じリソースを使用します。削除して新たに1時間待つのではなく、そのままにしておきます。
