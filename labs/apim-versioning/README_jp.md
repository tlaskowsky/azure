# API管理：APIの変更とバージョン管理

APIは明確に定義されることが意図されているため、通常、APIの仕様には最初からバージョニングスキームを含めます。破壊的な変更を行う必要がある場合は、新しいバージョンの下でそれを行い、すべてのクライアントが新しいバージョンに移行したら、前のバージョンを廃止できます。

API Managementには、破壊的変更と非破壊的変更の両方に対応したバージョニングサポートが組み込まれています。これらはAzure App Servicesの_デプロイメントスロット_と非常にうまく連携し、アプリケーションコードの複数のバージョンを実行し、APIバージョンスキームを使用してAPIMがそれらの間でルーティングすることができます。

このラボでは、最初からバージョニングを持つAPIを作成し、APIMとデプロイメントスロットがどのようにしてマイナーリビジョンと新しいバージョンを公開するかを見ていきます。

## 参考資料

- [APIMでのバージョニング](https://azure.microsoft.com/en-gb/blog/api-versioning-with-azure-api-management/)

- [APIMのバージョンとリビジョン](https://azure.microsoft.com/en-gb/blog/versions-revisions/)

- [デプロイメントスロットを使ったステージング環境](https://learn.microsoft.com/en-us/azure/app-service/deploy-staging-slots)

## APIのバージョン1.0をデプロイ

このラボでは、ランダムナンバージェネレータAPIのいくつかのバージョンをデプロイし、APIMでAPI仕様をどのように進化させるかを見ていきます。

まず、APIのバージョン1.0用の新しいWebアプリを、APIMインスタンスが実行されているのと同じリソースグループで実行します：


``` 
# APIソースコードがあるフォルダに移動します:
cd src/rng/Numbers.Api

# Standard SKUを使用します:
az webapp up -g labs-apim --os-type Linux --sku S1 --runtime dotnetcore:6.0 -l westus -n <webapp-name>
```


> Standard SKUは5つのデプロイメントスロットを提供します

これらのスロットを使用して、同時にアプリの異なるバージョンを実行できます。

次に、APIMで新しいAPIを作成します：

- OpenAPI仕様から作成
- ウィンドウで_Full_ UIを選択
- _このAPIをバージョン管理しますか？_のチェックボックスをオン
- _バージョン識別子_に`1.0`を設定
- _バージョニングスキーム_に_Header_を設定
- _バージョンヘッダー_に`x-api-version`を設定

リポジトリの`labs/apim-versioning/rng-v1.0.json`から仕様をアップロードします。

Webアプリが実行されている場合、そのURLをAPIのWebサービスURLとして設定します（例：`https://myrngapi.azurewebsites.net`）。

APIMデザイナーで`rng`操作をテストします。HTTPリクエストがヘッダーでAPIバージョン1.0を指定していることに注意してください - **これは消費者にとって要求事項になります**。バージョン付きのAPIは、どのバージョンを呼び出しているのかを知る必要があります。

## バージョン1.1へのリビジョンを追加

_リビジョン_とは、既存の操作にオプションパラメータを追加するような非破壊的変更です。消費者は更新する必要はありません。なぜなら、新しいパラメータが提供されていない場合にはデフォルトを使用するようにコード変更が行われているからです。

1.1リリースのために新しいデプロイメントスロットを作成し、1.0リリースと並行して実行し、本番環境に移行する前にテストします。ブルー-グリーンデプロイメントの命名規則を使用します：


```
az webapp deployment slot create -g labs-apim --slot blue -n <webapp-name>
```


新しいバージョンのRNG APIを青いスロットにデプロイします：


```
# リポジトリのルートフォルダから実行します：
az webapp deployment source config-zip -g labs-apim --src src/rng/Numbers.Api-v1.1/rng-api-v1-1.zip --slot blue -n <web-app-name>
```


Webアプリを開き、_デプロイメントスロット_をチェックします。`Production`と`blue`が表示されます。`blue`リンクをクリックします - **このスロットには独自のURLがあります**。

> これで新しい機能をテストできます - APIMのリビジョンは新しいスロットを指します

元の1.0デプロイメントは`Production`スロットを指しています。

RNG APIの_リビジョン_タブを開きます。既存のリビジョンが1つあります。_リビジョンを追加_をクリックし、新しいリビジョンの説明を入力します：


```
これで、クエリストリングでminおよび`max`パラメータを使用して、ランダムな数値の範囲を設定できるようになりました！

```

APIビューの_Design_タブ上部に、現在「_REVISION 2_」と表示されています。

_Settings_タブを開き、WebサービスURLをデプロイメントスロットのURLに変更します。これにより、リビジョン1は_Production_スロットを、リビジョン2は_blue_スロットを指すようになります。エンドユーザーはこのURLを見ることはないので、名前が奇妙であっても問題ありません。

_Design_タブでrng操作を開き、_Frontend_を編集して次の2つのクエリパラメータを追加します：

- min
- max

両方の「Required」はチェックを外しておきます。

_Test_タブで、minとmaxの値を確認できます。それらを15と45に設定し、呼び出しをテストしてください。その後、これらを削除して再びテストします。パラメータを含めても含めなくても、動作するレスポンスが得られるはずです。

> APIMはリビジョンをURLに追加して、ライブリビジョンと区別します：`https://<apim-name>.azure-api.net/rand;rev=2/rng`

_Revisions_タブに戻り、リビジョン2を現在のものにします。これで通常のURLが1.1リリースを指すようになります。

curlでテストし、オリジナルURLにminとmaxパラメータを追加できます。これらを含めなくてもアプリは動作するため、消費者が変更する必要はありません。

## APIバージョン2.0を公開する

オプションのパラメータは理想的ではありません。これらは適切に検証できません。v1.0のクライアントは、400のレスポンスを受け取ることを想定していないため、これをリビジョンに追加することはできません。なぜなら、それは彼らのコードを壊す可能性があるからです。

APIを適切な検証と更新された仕様でクリーンアップするには、新しいバージョンが必要です。

まず、v2.0コードを新しいデプロイメントスロットにデプロイします：



```
az webapp deployment slot create -g labs-apim --slot green -n <webapp-name>

az webapp deployment source config-zip -g labs-apim --src src/rng/Numbers.Api-v2/rng-api-v2-0.zip --slot green -n <web-app-name>
```

## APIMでAPIの新しいバージョンを作成：

- バージョン `2.0`
- バージョニングスキーム `Header`
- バージョンヘッダー `x-api-version`
- 完全なAPIバージョン名 `rng-api-v2`

`labs/apim-versioning/rng-v2.0.json`ファイルから2.0バージョンにOpenAPI仕様をインポートし、_Update_ 方法を選択します。

バージョン2.0の_Settings_タブで、`green` デプロイメントスロットのURLをWebサービスURLとして使用します。

v2.0 `rng` 操作をテストします - minとmaxは現在必須で、設定されていない場合は400レスポンスが返されます。

両方のバージョンを稼働させ、リビジョンと新しいデプロイメントスロットで1.1と2.0の両方をサポートし続けることができます。

## ラボ

これは本当にブルーグリーンデプロイメントですか？App Serviceのデプロイメントスロットは交換可能で、ブルーグリーン体験を提供しますが、APIMが前にいる場合は可能でしょうか？

> 詰まったら、[私の提案](suggestions_jp.md)を試してみてください。
___

## クリーンアップ

APIMの作業が完了したので、APIMインスタンスとすべてのバックエンドを含むRGを削除することができます：



```
az group delete -y --no-wait -n labs-apim
```
