# ãƒ­ã‚°åˆ†æ

ãƒ­ã‚°åˆ†æã¯ã€Azureã§ã®ã‚ã‚‰ã‚†ã‚‹ç¨®é¡ã®ãƒ­ã‚°åé›†ã®ãŸã‚ã®ãƒ‡ãƒ¼ã‚¿ã‚¹ãƒˆã‚¢ã§ã™ã€‚ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚¤ãƒ³ã‚µã‚¤ãƒˆã¯ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ­ã‚°åˆ†æã«é€ä¿¡ã—ã€ä»®æƒ³ãƒã‚·ãƒ³ã«ç›´æ¥ä½¿ç”¨ã™ã‚‹ã“ã¨ã‚‚ã§ãã€ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã«ä¿å­˜ã•ã‚Œã¦ã„ã‚‹ãƒ­ã‚°ã‚’å–ã‚Šè¾¼ã‚€ãŸã‚ã«ã‚‚ä½¿ç”¨ã§ãã¾ã™ã€‚

Azureãƒãƒ¼ã‚¿ãƒ«ã«ã¯ã€ãƒ­ã‚°åˆ†æã®ãƒ‡ãƒ¼ã‚¿ã‚’ç…§ä¼šã™ã‚‹ãŸã‚ã®è±Šå¯ŒãªUIãŒã‚ã‚Šã€Kustoã‚¯ã‚¨ãƒªè¨€èªï¼ˆKQLï¼‰ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚ä»–ã®ç›£è¦–ãƒ„ãƒ¼ãƒ«ï¼ˆãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚„ã‚¢ãƒ©ãƒ¼ãƒˆã‚’å‹•åŠ›ã™ã‚‹ãŸã‚ï¼‰ã§ãƒ­ã‚°åˆ†æãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨ã™ã‚‹å ´åˆã€KQLã‚’ä½¿ç”¨ã—ã€ãã‚Œã‚‰ã®ãŸã‚ã®ã‚¯ã‚¨ãƒªã‚’è¨˜è¿°ã—ã€ãƒ†ã‚¹ãƒˆã™ã‚‹ãŸã‚ã«ãƒ­ã‚°åˆ†æã‚’ä½¿ç”¨ã—ã¾ã™ - ã¾ãŸã€å¯¾è©±å¼ã®ç…§ä¼šã«ã‚‚ä½¿ç”¨ã—ã¾ã™ã€‚

ã“ã®ãƒ©ãƒœã§ã¯ã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚¤ãƒ³ã‚µã‚¤ãƒˆã«ã‚ˆã£ã¦åé›†ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã«ãƒ­ã‚°åˆ†æãŒã©ã®ã‚ˆã†ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã‹ã‚’è¦‹ã¦ã€KQLã‚’ä½¿ã£ãŸçµŒé¨“ã‚’ç©ã¿ã¾ã™ã€‚

## å‚è€ƒè³‡æ–™

- [ãƒ­ã‚°åˆ†æã®æ¦‚è¦](https://learn.microsoft.com/ja-jp/azure/azure-monitor/logs/log-analytics-overview)

- [Kustoã‚¯ã‚¨ãƒªãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«](https://learn.microsoft.com/ja-jp/azure/azure-monitor/logs/get-started-queries)

- [Kustoã‚¯ã‚¨ãƒªè¨€èªãƒªãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹](https://learn.microsoft.com/ja-jp/azure/data-explorer/kusto/query/)


## ãƒ­ã‚°ãƒ‡ãƒ¼ã‚¿ã®ç”Ÿæˆ

**[ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚¤ãƒ³ã‚µã‚¤ãƒˆã®ãƒ©ãƒœ](/labs/applicationinsights/README_jp.md)ã‚’å®Ÿæ–½ã—ã¦ãŠã‚Šã€`labs-appinsights`ãƒªã‚½ãƒ¼ã‚¹ã‚°ãƒ«ãƒ¼ãƒ—ã«ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚¤ãƒ³ã‚µã‚¤ãƒˆã¨ãƒ­ã‚°åˆ†æãŒã¾ã å­˜åœ¨ã™ã‚‹å ´åˆã¯ã€ã“ã®æ‰‹é †ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¦ãã ã•ã„ã€‚**

<details>
  <summary>ãƒ­ã‚°åˆ†æãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã‚’ä½œæˆã—ã€ãƒ­ã‚°ã‚’ç”Ÿæˆã™ã‚‹ã‚³ãƒ³ãƒ†ãƒŠã‚’å®Ÿè¡Œã™ã‚‹</summary>

ç›£è¦–ç”¨ã®RGã‚’ä½œæˆã—ã€ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã¨ã‚¢ãƒ—ãƒªã‚¤ãƒ³ã‚µã‚¤ãƒˆã‚’è¿½åŠ ï¼š



```
az group create -n labs-appinsights -l eastus --tags courselabs=azure

az monitor log-analytics workspace create -g labs-appinsights -n labsloganalytics -l eastus

az monitor app-insights component create --app labs --kind web -g labs-appinsights --workspace labsloganalytics -l eastus
```


ã‚¢ãƒ—ãƒªã‚¤ãƒ³ã‚µã‚¤ãƒˆã®æ¥ç¶šæ–‡å­—åˆ—ã‚’å–å¾—ï¼š


```
az monitor app-insights component show --app labs -g labs-appinsights --query connectionString -o tsv
```


ã‚µãƒ³ãƒ—ãƒ«ã‚¢ãƒ—ãƒªç”¨ã®åˆ¥ã®RGã‚’ä½œæˆã—ã€ã‚¢ãƒ—ãƒªã‚¤ãƒ³ã‚µã‚¤ãƒˆã¸ã®æ›¸ãè¾¼ã¿ã‚’è¡Œã†ACIã‚³ãƒ³ãƒ†ãƒŠã‚’ä½œæˆï¼š


```
az group create -n labs-appinsights-apps --tags courselabs=azure -l eastus

az container create -g labs-appinsights-apps  --image courselabs/fulfilment-processor:appinsights-1.0 --no-wait --name fp1 --secure-environment-variables "ApplicationInsights__ConnectionString=<appinsights-connection-string>"

az container create -g labs-appinsights-apps  --image courselabs/fulfilment-processor:appinsights-1.0 --no-wait --name fp2 --secure-environment-variables "ApplicationInsights__ConnectionString=<appinsights-connection-string>"

az container create -g labs-appinsights-apps  --image courselabs/fulfilment-processor:appinsights-1.0 --no-wait --name fp3 --secure-environment-variables "ApplicationInsights__ConnectionString=<appinsights-connection-string>"

az container create -g labs-appinsights-apps  --image courselabs/fulfilment-processor:appinsights-1.2 --no-wait --name fp4 --secure-environment-variables "ApplicationInsights__ConnectionString=<appinsights-connection-string>"
```


</details><br />

ACIã‚³ãƒ³ãƒ†ãƒŠã¯å¤šãã®ãƒ­ã‚°ã¨ãƒ¡ãƒˆãƒªãƒƒã‚¯ã‚’ç”Ÿæˆã™ã‚‹ã®ã§ã€ä½œæ¥­ã«ååˆ†ãªãƒ‡ãƒ¼ã‚¿ãŒå¾—ã‚‰ã‚Œã‚‹ã¯ãšã§ã™ã€‚

## ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ­ã‚°ã®ç…§ä¼š

ãƒãƒ¼ã‚¿ãƒ«ã§ãƒ­ã‚°åˆ†æãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã‚’é–‹ãã€_ãƒ­ã‚°_ ãƒ“ãƒ¥ãƒ¼ã«ç§»å‹•ã—ã¾ã™ã€‚å¤šãã®ã‚µãƒ³ãƒ—ãƒ«ã‚¯ã‚¨ãƒªãŒè¡¨ç¤ºã•ã‚Œã¾ã™ãŒã€ã“ã“ã§ã¯å½¹ã«ç«‹ãŸãªã„ã®ã§ã€ãã®ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚’é–‰ã˜ã¦æ§‹ã„ã¾ã›ã‚“ã€‚

ã“ã‚Œã§KQLã‚¯ã‚¨ãƒªã‚¨ãƒ‡ã‚£ã‚¿ã«å…¥ã‚Šã¾ã™ã€‚å·¦å´ã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«ã¯ã‚µãƒ³ãƒ—ãƒ«ã‚¯ã‚¨ãƒªã®ãƒªã‚¹ãƒˆãŒã‚ã‚Šã¾ã™ãŒã€ã“ã“ã§ã‚‚å½¹ã«ç«‹ãŸãªã„ã®ã§ã€_ãƒ†ãƒ¼ãƒ–ãƒ«_ ãƒ“ãƒ¥ãƒ¼ã«åˆ‡ã‚Šæ›¿ãˆã¾ã™ï¼š

![ãƒ­ã‚°åˆ†æãƒ†ãƒ¼ãƒ–ãƒ«](/img/loganalytics-query-editor.png)

ã“ã‚Œã‚‰ã¯ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹å†…ã®å®Ÿéš›ã®ãƒ‡ãƒ¼ã‚¿ãƒ†ãƒ¼ãƒ–ãƒ«ã§ã™ã€‚_LogManagement_ ã‚’å±•é–‹ã™ã‚‹ã¨ã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚¤ãƒ³ã‚µã‚¤ãƒˆã‹ã‚‰å–å¾—ã•ã‚ŒãŸå¤šãã®ãƒ†ãƒ¼ãƒ–ãƒ«ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚

KQLã‚¯ã‚¨ãƒªã®æœ€ã‚‚å˜ç´”ãªå½¢å¼ã¯ã€ãƒ†ãƒ¼ãƒ–ãƒ«åã ã‘ã§ã™ã€‚ã“ã‚Œã‚‰ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’é¸æŠã—ã¦ã¿ã¦ãã ã•ã„ï¼š

- AppEvents
- AppDependencies
- AppTraces

ã“ã‚Œã¯ã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚¤ãƒ³ã‚µã‚¤ãƒˆã®ç•°ãªã‚‹ãƒ“ãƒ¥ãƒ¼ã§è¡¨ç¤ºã•ã‚Œã‚‹ã®ã¨åŒã˜ãƒ‡ãƒ¼ã‚¿ã§ã™ã€‚`AppTraces`ã«ã¯ã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«ã‚ˆã£ã¦æ›¸ãè¾¼ã¾ã‚ŒãŸå®Ÿéš›ã®ãƒ­ã‚°ã‚¨ãƒ³ãƒˆãƒªãŒå«ã¾ã‚Œã¦ã„ã¾ã™ã€‚

ã•ã‚‰ã«KQLã‚¯ã‚¨ãƒªã‚’æ¢ç´¢ã—ã¦ã¿ã¦ãã ã•ã„ - SQLã«ä¼¼ã¦ã„ã¾ã™ãŒã€ã¯ã‚‹ã‹ã«å¤šãã®é–¢æ•°ãŒã‚ã‚Šã€æ§‹æ–‡ã¯ã‚ˆã‚Šå³å¯†ã§ã™ã€‚å€‹ã€…ã®ã‚¯ã‚¨ãƒªã¯æ”¹è¡Œã‚’å«ã‚€ã“ã¨ãŒã§ããšã€å¥ã¯ãƒ‘ã‚¤ãƒ—ï¼ˆ`|`ï¼‰ã§åŒºåˆ‡ã‚‰ã‚Œã¾ã™ï¼š


```
AppTraces
| limit 100

AppMetrics
| order by TimeGenerated desc 
| limit 10

AppTraces
| distinct SeverityLevel

AppTraces
| summarize LogsBySeverity = count() by(SeverityLevel)
```

ã“ã“ã§ä½•ã‚’è¦‹ã¦ã„ã¾ã™ã‹ï¼Ÿ æœ€åˆã®100å€‹ã®ãƒ­ã‚°ã‚¨ãƒ³ãƒˆãƒªï¼›æœ€ã‚‚æœ€è¿‘ã®ãƒ­ã‚°ã‚¨ãƒ³ãƒˆãƒª10å€‹ï¼›ã™ã¹ã¦ã®ãƒ­ã‚°ã«ã‚ãŸã‚‹ãƒ­ã‚°é‡å¤§åº¦ã®ãƒªã‚¹ãƒˆï¼›å„ãƒ­ã‚°é‡å¤§åº¦ã®ã‚«ã‚¦ãƒ³ãƒˆã§ã®å†…è¨³ã€‚é‡å¤§åº¦3ã®ãƒ­ã‚°ã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿ

ğŸ“‹ ç‰¹å®šã®é‡å¤§åº¦ãƒ¬ãƒ™ãƒ«ã®å€‹ã€…ã®ãƒ­ã‚°ã‚¨ãƒ³ãƒˆãƒªã‚’è¦‹ã¤ã‘ã‚‹ãŸã‚ã®KQLã‚’è¨˜è¿°ã—ã¦ãã ã•ã„ - å„ã‚¨ãƒ³ãƒˆãƒªã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³åã€ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹åã®ã¿ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚

ğŸ“‹ é‡å¤§åº¦3ã®ãƒ­ã‚°ã«ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰302ãŒä½•å€‹ã‚ã‚Šã¾ã™ã‹ï¼Ÿ

ğŸ“‹ ã‚ã‚‹ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒä»–ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚ˆã‚Šã‚‚å¤šãã® `Fulfilment.Failed` ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¨˜éŒ²ã—ã¦ã„ã‚‹ã‹ã©ã†ã‹ã‚’ç¢ºèªã§ãã¾ã™ã‹ï¼Ÿ

## ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ¡ãƒˆãƒªãƒƒã‚¯ã®é›†è¨ˆ

App Insightsã‹ã‚‰ã®ã™ã¹ã¦ã¯ã€ãƒ†ãƒ¼ãƒ–ãƒ«å†…ã®è¡Œã¨ã—ã¦è¨˜éŒ²ã•ã‚Œã¾ã™ã€‚ã¤ã¾ã‚Šã€å€‹ã€…ã®ãƒ­ã‚°ã‚¨ãƒ³ãƒˆãƒªã‚’è©³ç´°ã«èª¿ã¹ã‚‹ãŸã‚ã«ã‚‚ã€ãƒ¡ãƒˆãƒªãƒƒã‚¯ã‚’ã¾ã¨ã‚ã‚‹ãŸã‚ã«ã‚‚ã€åŒã˜ã‚¯ã‚¨ãƒªè¨€èªã‚’ä½¿ç”¨ã—ã¾ã™ã€‚

`AppMetrics` ãƒ†ãƒ¼ãƒ–ãƒ«ã¯ã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«ã‚ˆã£ã¦å ±å‘Šã•ã‚Œã‚‹ã‚«ã‚¹ã‚¿ãƒ ãƒ¡ãƒˆãƒªãƒƒã‚¯ã‚’ä¿å­˜ã—ã¾ã™ã€‚ã“ã‚Œã‚‰ã®ã‚¯ã‚¨ãƒªã‚’è©¦ã—ã¦ã¿ã¦ãã ã•ã„ï¼š



```
AppMetrics
| count

AppMetrics
| limit 10

AppMetrics
| where (Name == "QueueSize")
| summarize AvgQueueLength = avg(Sum)
```


ãã‚Œã¯ä½•ã§ã—ãŸã‹ï¼Ÿ è¨˜éŒ²ã•ã‚ŒãŸã™ã¹ã¦ã®ãƒ¡ãƒˆãƒªãƒƒã‚¯ã®ã‚«ã‚¦ãƒ³ãƒˆï¼›ãƒ¡ãƒˆãƒªãƒƒã‚¯ã®æœ€åˆã®10è¡Œï¼›`QueueSize` ãƒ¡ãƒˆãƒªãƒƒã‚¯ã®å¹³å‡ã€‚

ãã®å¹³å‡ã¯ã™ã¹ã¦ã®æ™‚é–“ã«ã‚ãŸã‚‹å¹³å‡ã§ã‚ã‚‹ãŸã‚ã€ã‚ã¾ã‚Šå½¹ã«ç«‹ã¡ã¾ã›ã‚“ã€‚ã‚ˆã‚Šæœ‰ç”¨ãªã®ã¯ã€æ™‚é–“ã®çµŒéã¨ã¨ã‚‚ã«å¹³å‡ã‚­ãƒ¥ãƒ¼é•·ã‚’åˆ†è§£ã™ã‚‹ã“ã¨ã§ã€ä¸Šæ˜‡å‚¾å‘ã‹ä¸‹é™å‚¾å‘ã‹ã€ã¾ãŸã¯å¤–ã‚Œå€¤ãŒã‚ã‚‹ã‹ã©ã†ã‹ã‚’ç¢ºèªã§ãã¾ã™ã€‚

ğŸ“‹ 10åˆ†é–“éš”ã§é›†è¨ˆã—ãŸå ´åˆã®å¹³å‡ã‚­ãƒ¥ãƒ¼ã‚µã‚¤ã‚ºã¯ã©ã®ã‚ˆã†ã«è¦‹ãˆã¾ã™ã‹ï¼Ÿ

ğŸ“‹ ãã®ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ã‚ˆã‚Šæœ‰ç”¨ãªè¦–è¦šåŒ–ã§è¡¨ç¤ºã§ãã¾ã™ã‹ï¼Ÿ

## ãƒ©ãƒœ

ãƒ­ã‚°åˆ†æã®è¦–è¦šåŒ–ã¯ã‚¯ã‚¤ãƒƒã‚¯ã‚¯ã‚¨ãƒªã«é©ã—ã¦ã„ã¾ã™ãŒã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®å¥åº·çŠ¶æ…‹ã¨ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã«ã¤ã„ã¦ã‚ˆã‚Šæœ‰ç”¨ãªãƒ“ãƒ¥ãƒ¼ãŒå¿…è¦ãªå ´åˆã¯ã€ãƒ¯ãƒ¼ã‚¯ãƒ–ãƒƒã‚¯ã‚’ä½œæˆã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚Azureã®ãƒ¯ãƒ¼ã‚¯ãƒ–ãƒƒã‚¯UXã«ã¯æ…£ã‚Œã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ãŒã€è¦–è¦šåŒ–ã¯ãƒ­ã‚°åˆ†æãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ä¸Šã®KQLã‚¯ã‚¨ãƒªã«ã‚ˆã£ã¦å‹•åŠ›ã‚’å¾—ã¦ã„ã¾ã™ã€‚

`Fulfilment.Processor` ã‚¢ãƒ—ãƒªã®ãƒ¯ãƒ¼ã‚¯ãƒ–ãƒƒã‚¯ã‚’ä½œæˆã—ã€ä»¥ä¸‹ã‚’ç¤ºã—ã¾ã™ï¼š

- ç¾åœ¨å®Ÿè¡Œä¸­ã®ã™ã¹ã¦ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®ãƒ†ãƒ¼ãƒ–ãƒ«
- ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã”ã¨ã«åˆ†å‰²ã•ã‚ŒãŸ `Fulfilment.Failed` ã‚¤ãƒ™ãƒ³ãƒˆã®å†…è¨³
- 10åˆ†é–“éš”ã§å¹³å‡ã•ã‚ŒãŸ `QueueSize` ã®ã‚°ãƒ©ãƒ•

> è©°ã¾ã£ãŸå ´åˆã¯ã€[ãƒ’ãƒ³ãƒˆ](hints_jp.md)ã‚’è©¦ã™ã‹ã€[è§£æ±ºç­–](solution_jp.md)ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚

___

## ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—

RGã‚’å‰Šé™¤ã™ã‚‹ã¨ã€ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚‚å‰Šé™¤ã•ã‚Œã¾ã™ï¼š



```
az group delete -y --no-wait -n labs-appinsights-apps

az group delete -y --no-wait -n labs-appinsights
```
